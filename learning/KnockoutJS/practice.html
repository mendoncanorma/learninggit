<html>

<head>
    <title>Example: Custom Binding</title>
    <script src="jquery-1.11.3.min.js"></script>
    <script src="knockout-min.js"></script>
</head>
    
<body>
    
    <div id="view18">
        
        <ul data-bind="foreach: { data: myItems, afterRender: fnAfterRender, afterAdd: fnAfterAdd}"><li data-bind="text: $data"></li></ul>
        <button data-bind="click: addItem">Add</button><br />
        <p>
            Select a country:
            <select data-bind=" options: countries, 
                                optionsCaption: 'Choose one...'"></select>
        </p>
        <br />

        <p>Send me spam: <input type="checkbox" data-bind="checked: wantsSpam" /></p>
        <div data-bind="visible: wantsSpam">
            Preferred flavors of spam:
            <div><input type="checkbox" data-bind="checkedValue: 'cherry', checked: spamFlavors" /> Cherry</div>
            <div><input type="checkbox" data-bind="checkedValue: 'almond', checked: spamFlavors" /> Almond</div>
            <div><input type="checkbox" data-bind="checkedValue: 'msg', checked: spamFlavors" /> Monosodium Glutamate</div>
        </div>
        <br />

        <p>Send me spam: <input type="checkbox" data-bind="checked: wantsSpam" /></p>
        <div data-bind="visible: wantsSpam">
            Preferred flavor of spam:
            <div><input type="radio" name="flavorGroup" value="cherry" data-bind="checked: spamFlavor" /> Cherry</div>
            <div><input type="radio" name="flavorGroup" value="almond" data-bind="checked: spamFlavor" /> Almond</div>
            <div><input type="radio" name="flavorGroup" value="msg"    data-bind="checked: spamFlavor" /> Monosodium Glutamate</div>
        </div>
        <br />

        <p>
            Your country:
            <!-- <select data-bind="options: availableCountries,
                               optionsText: 'countryName',
                               value: selectedCountry1,
                               optionsCaption: 'Choose...'"></select> -->
            <!-- Same as example 3, except the <select> box expressed as follows: -->
            <select data-bind="options: availableCountries,
                               optionsText: function(item) {
                                   return item.countryName + ' (pop: ' + item.countryPopulation + ')'
                               },
                               value: selectedCountry1,
                               optionsCaption: 'Choose...'"></select>                               
        </p>         
        <div data-bind="visible: selectedCountry1"> <!-- Appears when you select something -->
            You have chosen a country with population

            <span data-bind="text: selectedCountry1()"></span><span data-bind="text: selectedCountry1() ? selectedCountry1().countryPopulation : 'unknown'"></span>.
        </div>

    </div>
    <hr />
    <div id="view17">
        <p>First name: <input data-bind="value: firstName" /></p>
        <p>Last name: <input data-bind="value: lastName" /></p>
        <h2>Hello, <span data-bind="text: fullName"> </span>!</h2>
    </div>
    <hr />
    <div id="view16">
        <div class="heading">
            <input type="checkbox" title="Select all/none" data-bind="checked: selectedAllProduce" /> Produce
        </div>
        <div data-bind="foreach: produce">
            <label>
                <input type="checkbox" data-bind="checkedValue: $data, checked: $parent.selectedProduce" />
                <span data-bind="text: $data"></span>
            </label>
        </div>
    </div>
    <hr />
    <div id="form15">
        <form data-bind="submit: getTweets">
            Twitter Account:
            <input data-bind="value: twitterName" />
            <button type="submit">Get Tweets</button>
        </form>
        
        <div data-bind="with: resultData">
            <h3>Recent tweets fetched at <span data-bind="text: retrievalDate"></span></h3>
            <ol data-bind="foreach: topTweets">
                <li data-bind="text: $data.text"></li>
            </ol>
            
            <button data-bind="click: $parent.clearResults">Clear tweets</button>
            
        </div>        
    </div>    
    <form id="form1" data-bind="submit: addItem">
        <h1>Form 1</h1>
        New Item:
        <input type="text" data-bind="value: itemToAdd, valueUpdate: 'afterkeydown'" />
        <button type="submit" data-bind="enable: itemToAdd().length > 0">Add</button>
        <p>Your Items</p>
        <select multiple data-bind="options: items"></select>
        <button type="button" data-bind="click: reverseItems">Reverse</button>        
    </form>
    <hr />
    <form id="form2">
        <h1>Form 2</h1>
        <input type="text" data-bind="value: firstName, valueUpdate: 'afterkeydown'" />
        <br />
        <input type="text" data-bind="value: lastName, valueUpdate: 'afterkeydown'" />
        <br />
        FullName: <span data-bind="text: fullName()"></span>
    </form>
    <hr />
    <form id="form3">
        <div class="heading">
            <input type="checkbox" data-bind="checked: selectedAllProduce" title="Select all/none"/> Produce
        </div>
        <div data-bind="foreach: produce">
            <label>
                <input type="checkbox" data-bind="checkedValue: $data, checked: $parent.selectedProduce"/>
                <span data-bind="text: $data"></span>
            </label>
        </div>    
    </form>
    <hr />
    <div id="form4">
        <div>First name: <span data-bind="text: firstName"></span></div>
        <div>Last name: <span data-bind="text: lastName"></span></div>
        <div class="heading">Hello, <input data-bind="textInput: fullName"/></div>
    </div>
    <hr />
    <div id="form5">
        <div>Enter bid price: <input data-bind="textInput: formattedPrice"/></div>
        <div>(Raw value: <span data-bind="text: price"></span>)</div>    
    </div>
    <hr />
    <div id="form6">
        <div data-bind="css: profitStatus">
           Profit Status
        </div>        
        <div data-bind="css: {'current-profit': currentProfit() > 0}">
           Current Profit
        </div>                
    </div>
    <hr />
    <div id="form7">
        <table>
            <thead>
                <tr>
                    <th>FirstName</th>
                    <th>LastName</th>
                </tr>
            </thead>

            <tbody data-bind="foreach: people">
                <tr>
                    <td data-bind="text: firstName"></td>
                    <td data-bind="text: lastName"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <hr />
    <div id="form8">
        <table>
            <thead>
                <th>Position</th>
                <th>Name</th>
                <td>Remove</td>
            </thead>
            <tbody data-bind="foreach: {data: people}">
                <tr>
                    <td data-bind="text: $index()+1"></td>
                    <td data-bind="text: $data.name"></td>
                    <td data-bind="click: removePerson">Remove</td>
                </tr>
            </tbody>
        </table>
        <input type="button" data-bind="click: addPerson" value="Add" />
    </div>
    <hr />
    <div id="form9">
        <ul data-bind="foreach: { data: categories, as: 'category' }">
            <li>
                <ul data-bind="foreach: { data: items, as: 'item' }">
                    <li>
                        <span data-bind="text: $parent.name"></span>
                        <span data-bind="text: category.name"></span>:
                        <span data-bind="text: item"></span>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <hr />
    <div id="form10">
        <ul data-bind="foreach: { data: categories, as: 'category' }">
            <li>
                <ul>
                    <!-- ko foreach: { data: items, as: 'item' } -->
                    <li>
                        <span data-bind="text: $parent.name"></span>
                        <span data-bind="text: category.name"></span>:
                        <span data-bind="text: item"></span>
                    </li>
                    <!-- /ko -->
                </ul>
            </li>
        </ul>
    </div>
    <hr />
    <div id="form11">
        <!-- foreach: { data: myItems, afterRender: fnAfterRender, afterAdd: fnAfterAdd, beforeRemove: fnBeforeRemove } -->
        <ul data-bind="foreach: { data: myItems, afterRender: fnAfterRender, afterAdd: fnAfterAdd, beforeRemove: fnBeforeRemove }"><li><span data-bind="text: $data"></span>&nbsp;<span data-bind="click: $parent.removeItem">Remove</span></li></ul>
        <button data-bind="click: addItem">Add</button>
    </div>
    <hr />
    <div id="form12">
        
        <ul data-bind="foreach: { data: myItems }">
            <li><span data-bind="text: $data.name"></span>&nbsp;<span data-bind="click: $parent.removeItem">Remove</span></li>
        </ul>
        <button data-bind="click: addItem">Add</button>
    </div>
    <hr />
    <div id="form13">
        <label><input type="checkbox" data-bind="checked: displayMessage" /> Display message</label>
        
        <!-- ko if: displayMessage -->
        <div>Here is a message. Astonishing.</div>
        <!-- /ko -->
    </div>
    <hr />
    <div id="form14">
        <h1 data-bind="text: city"> </h1>
        <p data-bind="with: coords">
            Latitude: <span data-bind="text: latitude"> </span>,
            Longitude: <span data-bind="text: longitude"> </span>
        </p>
    </div> 
    
    <script type="text/javascript">

        /*
        // Here's my data model
        var ViewModel18 = {
            alphabets: ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z'],
            
            myItems: ko.observableArray(['E', 'F']),
            
            addItem: function () {
                var rand = this.alphabets[Math.floor(Math.random() * this.alphabets.length)];
                if (this.myItems.indexOf(rand) < 0) {
                    this.myItems.push(rand);        
                }
            },

            fnAfterRender: function (elements, data) {
                // console.log(  );
            },

            fnAfterAdd: function (element, index, data) {
                console.log("fnAfterAdd: ");
                // console.log(element);
                console.log(index);
                // console.log(data);
            }

        };
        
        ko.applyBindings(ViewModel18, $('#view18')[0]);
        */

        // Constructor for an object with two properties
        var Country = function(name, population) {
            this.countryName = name;
            this.countryPopulation = population;
        };

        var ViewModel18 = { 
            myItems: ko.observableArray([ 'A', 'B', 'C' ]), 
            fnAfterRender: function(element, index, data) { 
                // $(element).filter("li") .animate({ backgroundColor: 'yellow' }, 200) .animate({ backgroundColor: 'white' }, 800); 
            }, 
            addItem: function() { 
                this.myItems.push('New item'); 
            },
            fnAfterRender: function (elements, data) {
                console.log( 'fnAfterRender: ' );
                console.log( $(elements).length );
            },            
            fnAfterAdd: function (element, index, data) {
                console.log("fnAfterAdd: ");
                // console.log(element);
                console.log(index);
                // console.log(data);
            },

            countries: ['Japan', 'Bolivia', 'New Zealand'],

            selectedCountry: ko.observable('Latvia'),

            wantsSpam: ko.observable(true),

            spamFlavors: ko.observableArray(["cherry","almond"]), // Initially checks the Cherry and Almond checkboxes            

            spamFlavor: ko.observable(true),

            availableCountries : ko.observableArray([
                new Country("UK", 65000000),
                new Country("USA", 320000000),
                new Country("Sweden", 29000000)
            ]),

            selectedCountry1 : ko.observable() // Nothing selected by default            

        };

        ko.applyBindings(ViewModel18, $('#view18')[0]);


        /* ******************************************************************************************************************** */

        // Here's my data model
        var ViewModel17 = {
            firstName: ko.observable("Planet"),
            lastName: ko.observable("Earth"),
        };
         

        ViewModel17.fullName = ko.pureComputed(function() {
            return this.firstName() + " " + this.lastName.peek();                
        }, ViewModel17);

        ko.applyBindings(ViewModel17, $('#view17')[0]);

        /* ******************************************************************************************************************** */

        function MyViewModel () {
            this.produce            = ['Apple', 'Banana', 'Celery', 'Corn', 'Orange', 'Spinach'];
            this.selectedProduce    = ko.observableArray([ 'Corn', 'Orange' ]);
            this.selectedAllProduce = ko.pureComputed({
                read: function () {
                    // console.log('read');
                    return ( this.selectedProduce().length === this.produce.length );
                },
                write: function (value) {
                    // console.log('write');
                    this.selectedProduce( value ?  this.produce.slice(0) : []);
                },
                owner: this
            }, this);
        }

        ko.applyBindings( new MyViewModel(), $('#view16')[0] );

        /* ******************************************************************************************************************** */

        var form15Model = function () {
            var self = this;
            
            self.twitterName = ko.observable("@example");
            self.resultData = ko.observable({ retrievalDate: new Date(), topTweets: [] });
            
            self.getTweets = function () {
                var name = self.twitterName(),
                    simulatedResults = [
                        { text: name + ' What a nice day.' },
                        { text: name + ' Building some cool apps.' },
                        { text: name + ' Just saw a famous celebrity eating lard. Yum.' }
                    ];
                
                self.resultData({ retrievalDate: new Date(), topTweets: simulatedResults });
                
            };
            
            self.clearResults = function () {
                self.resultData(undefined);
            };
        };
        
        ko.applyBindings( new form15Model(), $('#form15')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form1Model = function (items) {
            
            /* ********************************************************* */
            this.items = ko.observableArray(items);
            this.itemToAdd = ko.observable("");
            this.addItem = function () {
              if (this.itemToAdd() !== "") {
                  this.items.push(this.itemToAdd());
                  this.itemToAdd("");
              }  
            }.bind(this);
            this.reverseItems = function () {
                this.items.reverse();
            };
            
            this.itemToAdd.subscribe( function (newValue) {
                console.log( "after change: " + newValue );
            });
            
            this.itemToAdd.subscribe( function (newValue) {
                console.log( "before change: " + newValue );
            }, null, "beforeChange"); 
        };
        
        ko.applyBindings( new form1Model(["Alpha", "Beta", "Gamma"]), $('#form1')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form2Model = function () {
            this.firstName = ko.observable("");
            this.lastName = ko.observable("");
            this.fullName = ko.computed( function () {
                return this.firstName() + " " + this.lastName();
            }, this);
            
            // this.firstName.extend({ rateLimit: 500 });
            // this.lastName.extend({ rateLimit: 500 });
        };
        
        ko.applyBindings( new form2Model(), $('#form2')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form3Model = function () {
            this.produce = [ 'Apple', 'Banana', 'Celery', 'Corn', 'Orange', 'Spinach' ];
            this.selectedProduce = ko.observableArray([ 'Corn', 'Orange' ]);
            this.selectedAllProduce = ko.pureComputed({
                read: function () {
                    // Comparing length is quick and is accurate if only items from the
                    // main array are added to the selected array.
                    return this.selectedProduce().length === this.produce.length;
                },
                write: function (value) {
                    this.selectedProduce(value ? this.produce.slice(0) : []);
                },
                owner: this
            });
        };
        
        ko.applyBindings( new form3Model(), $('#form3')[0] );  
        
        /* ******************************************************************************************************************** */
        
        var form4Model = function () {
            this.firstName = ko.observable('Planet');
            this.lastName = ko.observable('Earth');

            this.fullName = ko.pureComputed({
                read: function () {
                    return this.firstName() + " " + this.lastName();
                },
                write: function (value) {
                    var lastSpacePos = value.lastIndexOf(" ");
                    if (lastSpacePos > 0) { // Ignore values with no space character
                        this.firstName(value.substring(0, lastSpacePos)); // Update "firstName"
                        this.lastName(value.substring(lastSpacePos + 1)); // Update "lastName"
                    }
                },
                owner: this
            });
        };
        
        ko.applyBindings( new form4Model(), $('#form4')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form5Model = function () {
            this.price = ko.observable(25.99);

            this.formattedPrice = ko.pureComputed({
                read: function () {
                    return "$" + this.price().toFixed(2);
                },
                write: function (value) {
                    value = value.replace(/[^\.\d]/g, "");
                    this.price( isNaN(value) ? 0 : parseFloat(value) );
                },
                owner: this
            });
        };
        
        ko.applyBindings( new form5Model(), $('#form5')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form6Model = {
            profitStatus: ko.observable('red'),
            currentProfit: ko.observable(-150000)
        };
        
        ko.applyBindings( form6Model, $('#form6')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form7Model = {
            people: [
                { firstName: 'Bert', lastName: 'Bertington' },
                { firstName: 'Charles', lastName: 'Charlesforth' },
                { firstName: 'Denise', lastName: 'Dentiste' }
            ]    
        };
        
        ko.applyBindings( form7Model, $('#form7')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form8Model = function () {
            self = this;
            
            self.people = ko.observableArray([
                { name: 'Bert' },
                { name: 'Charles' },
                { name: 'Denise' }                
            ]);
            
            self.addPerson = function () {
                self.people.push({name: new Date()})  
            };
            
            self.removePerson = function () {
                self.people.remove(this);
            };
        };
        
        ko.applyBindings( form8Model, $('#form8')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form9Model = {
            categories: ko.observableArray([
                { name: 'Fruit', items: [ 'Apple', 'Orange', 'Banana' ] },
                { name: 'Vegetables', items: [ 'Celery', 'Corn', 'Spinach' ] }
            ])
        };
        
        ko.applyBindings( form9Model, $('#form9')[0] );        
        
        /* ******************************************************************************************************************** */
        
        var form10Model = {
            categories: ko.observableArray([
                { name: 'Fruit', items: [ 'Apple', 'Orange', 'Banana' ] },
                { name: 'Vegetables', items: [ 'Celery', 'Corn', 'Spinach' ] }
            ])
        };
        
        ko.applyBindings( form10Model, $('#form10')[0] );
        
        /* ******************************************************************************************************************** */
        
        var form11Model = {
            myItems: ko.observableArray([ "Norma 1", "Norma 2", "Norma 3"]),
            addItem: function() { 
                this.myItems.push("Norma " + (this.myItems().length+1)); 
            },
            removeItem: function(me) { 
                form11Model.myItems.remove(me);
            },
            fnAfterRender: function (array, dataitem) {
                $(array[0]).hide().slideDown();
            },
            fnAfterAdd: function(element, index, data) {
                if (element.nodeType === 1) $(element).hide().slideDown();
            },
            fnBeforeRemove: function (element, index, data) {
                if (element.nodeType === 1) $(element).fadeOut(function () {
                    $(element).remove()
                });
            }            
        };
        
        ko.applyBindings(form11Model, $('#form11')[0] );        
        
        /* ******************************************************************************************************************** */
        
        var form12Model = {
            myItems: ko.observableArray([ {name: "Norma 1"}, {name: "Norma 2"}, {name: "Norma 2"}]),
            addItem: function() { 
                this.myItems.push({name: "Norma " + (this.myItems().length+1)}); 
            },
            removeItem: function() { 
                form12Model.myItems.remove(this);
            }            
        };
        
        ko.applyBindings(form12Model, $('#form12')[0] );   
        
        /* ******************************************************************************************************************** */
        
        ko.applyBindings({
            displayMessage: ko.observable(false)
        }, $('#form13')[0]);
        
        /* ******************************************************************************************************************** */
        
        ko.applyBindings({
            city: "London",
            coords: {
                latitude:  51.5001524,
                longitude: -0.1262362
            }
        }, $('#form14')[0]);

    </script>
</body>
</html>